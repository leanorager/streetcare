---
const {
  count = 6,
  size = 56,
  personSize = 19,
  radius = 18,
  tilt = 8,
  scrollSens = 0.35,
  ease = 0.12,
  src = "/svg/singlemanlogo.svg",
  className = "",
} = Astro.props;
---

<div
  class={`logo-ring relative shrink-0 [perspective:1400px] ${className}`}
  style={`width:${size}px;height:${size}px;`}
  data-scroll-ring
  aria-label="Street Care logo"
>
  {
    Array.from({ length: count }).map((_, i) => (
      <img
        src={src}
        alt=""
        aria-hidden="true"
        class="logo-person block h-[19px] w-auto"
        style={`height:${personSize}px; --i:${i};`}
        draggable="false"
      />
    ))
  }
</div>

<script is:inline define:vars={{ radius, tilt, scrollSens, ease }}>
  (() => {
    const root = document.currentScript?.previousElementSibling;
    if (!root || !root.matches?.("[data-scroll-ring]")) return;

    const media = window.matchMedia("(prefers-reduced-motion: reduce)");
    if (media.matches) return;

    const items = Array.from(root.querySelectorAll("img"));
    const COUNT = items.length;
    const RADIUS = Number(radius) || 18;
    const TILT_X = Number(tilt) || 8;
    const SCROLL_SENS = Number(scrollSens) || 0.35;
    const EASE = Number(ease) || 0.12;

    // 1) Placer items rundt om Y-aksen + ud i Z
    for (let i = 0; i < COUNT; i++) {
      const angle = (360 / COUNT) * i;
      items[i].style.transform = `rotateY(${angle}deg) translateZ(${RADIUS}px)`;
    }

    // 2) Inertia scroll-rotation (delta-baseret)
    let targetRotY = 0;
    let currentRotY = 0;
    let ticking = false;
    let lastY = window.scrollY;

    function apply() {
      root.style.transform = `rotateX(${TILT_X}deg) rotateY(${currentRotY}deg)`;
    }

    function animate() {
      currentRotY += (targetRotY - currentRotY) * EASE;
      apply();

      if (Math.abs(targetRotY - currentRotY) > 0.01) {
        requestAnimationFrame(animate);
      } else {
        ticking = false;
      }
    }

    function onScroll() {
      const y = window.scrollY;
      const delta = y - lastY;
      lastY = y;

      targetRotY += delta * SCROLL_SENS;

      if (!ticking) {
        ticking = true;
        requestAnimationFrame(animate);
      }
    }

    apply();
    window.addEventListener("scroll", onScroll, { passive: true });

    media.addEventListener?.("change", () => {
      if (media.matches) {
        window.removeEventListener("scroll", onScroll);
        root.style.transform = `rotateX(${TILT_X}deg)`;
      } else {
        lastY = window.scrollY;
        apply();
        window.addEventListener("scroll", onScroll, { passive: true });
      }
    });
  })();
</script>
