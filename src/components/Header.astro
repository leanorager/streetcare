---
import Link from "../components/Link.astro";
import Button from "../components/Button.astro";
import Text from "../components/Text.astro";
import SubtleLink from "../components/SubtleLink.astro";

const pathname = new URL(Astro.request.url).pathname;
// Normaliser trailing slash (undtagen "/")
const currentPath = pathname !== "/" ? pathname.replace(/\/$/, "") : "/";
---

<header
  x-data="{ showmenu: false }"
  class="sticky top-0 z-40 w-full bg-off-white"
>
  <!-- Bar i fuld bredde -->
  <div class="px-4 lg:px-[60px]">
    <div class="flex items-center justify-between py-6">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-4 h-[54px]">
        <div
          id="logo-ring"
          class="relative w-[56px] h-[54px] shrink-0 translate-y-[1px]
                 [perspective:1400px]
                 [transform-style:preserve-3d]
                 [transform:rotateX(8deg)]"
          style="--count:6; --radius:18px;"
          aria-label="Street Care logo"
        >
          {
            Array.from({ length: 6 }).map((_, i) => (
              <img
                src="/svg/singlemanlogo.svg"
                alt=""
                aria-hidden="true"
                class="logo-person block absolute left-1/2 top-1/2
                     -translate-x-1/2 -translate-y-1/2
                     h-[19px] w-auto
                     will-change-transform"
                style={`--i:${i};`}
              />
            ))
          }
        </div>

        <Text teksttype="brand_label" stylingclasses="m-0 leading-none">
          STREET CARE
        </Text>
      </a>

      <!-- Scroll rotation til 3D-ringen -->
      <script is:inline>
        (() => {
          const ring = document.getElementById("logo-ring");
          if (!ring) return;

          const media = window.matchMedia("(prefers-reduced-motion: reduce)");
          if (media.matches) return;

          let ticking = false;

          const update = () => {
            ticking = false;
            const speed = 0.12;
            const deg = window.scrollY * speed;
            ring.style.setProperty("--rot", `${deg}deg`);
          };

          const onScroll = () => {
            if (ticking) return;
            ticking = true;
            requestAnimationFrame(update);
          };

          update();
          window.addEventListener("scroll", onScroll, { passive: true });

          media.addEventListener?.("change", () => {
            if (media.matches) {
              window.removeEventListener("scroll", onScroll);
              ring.style.removeProperty("--rot");
            } else {
              update();
              window.addEventListener("scroll", onScroll, { passive: true });
            }
          });
        })();
      </script>

      <!-- Desktop menu + CTA -->
      <div class="hidden lg:flex h-full items-center gap-[40px]">
        <nav class="flex h-full items-center gap-10">
          <SubtleLink href="/voresarbejde"> Vores arbejde </SubtleLink>

          <SubtleLink href="/blivfrivillig"> Bliv frivillig </SubtleLink>

          <SubtleLink href="/om"> Om os </SubtleLink>
        </nav>

        <div class="flex h-full items-center">
          <Button variant="solid-red" href="/stoet">Støt nu</Button>
        </div>
      </div>

      <!-- Mobile burger -->
      <button
        type="button"
        class="lg:hidden inline-flex items-center justify-center"
        aria-label="Åbn menu"
        x-on:click="showmenu = !showmenu"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-10 w-10 text-red"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M4 7h16M4 12h16M4 17h16"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile dropdown -->
  <nav
    class="relative z-50 lg:hidden border-t border-grey70/70 bg-off-white"
    x-show="showmenu"
    x-transition
    x-on:click.outside="showmenu = false"
  >
    <div class="px-4 py-6 flex flex-col gap-6">
      <SubtleLink href="/voresarbejde" x-on:click="showmenu = false">
        Vores arbejde
      </SubtleLink>

      <SubtleLink href="/blivfrivillig" x-on:click="showmenu = false">
        Bliv frivillig
      </SubtleLink>

      <SubtleLink href="/om" x-on:click="showmenu = false"> Om os </SubtleLink>

      <div class="pt-2">
        <div class="flex h-full items-center">
          <Button
            variant="solid-red"
            href="/stoet"
            x-on:click="showmenu = false"
          >
            Støt nu
          </Button>
        </div>
      </div>
    </div>
  </nav>
</header>
